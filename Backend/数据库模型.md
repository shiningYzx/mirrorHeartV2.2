# Database Module

> MySQL database schema & data access design for **mirrorHeart Project**

本模块负责定义项目的 **数据库结构、核心数据模型、索引策略及关键查询规范**，支撑以下核心业务能力：

- 邮箱登录与用户体系
- 个性化每日推荐与历史归档
- 声音社区（Feed / 帖子 / 评论 / 点赞 / 收藏）
- 每日一问（题库 + 音频回答）
- 拉模式 Feed（黑名单 / 可见范围 / 分页）
- 搜索、统计、管理后台的可扩展支持

------

## 1. Tech Stack

| 项目            | 选型                |
| --------------- | ------------------- |
| Database        | **MySQL 8.x**       |
| Engine          | InnoDB              |
| Charset         | utf8mb4             |
| Primary Key     | `CHAR(36)` UUID     |
| ORM             | MyBatis             |
| Delete Strategy | Soft Delete         |
| Feed Strategy   | Pull Model (拉模式) |

------

## 2. Design Principles

### 2.1 Why UUID (CHAR(36))

- 与 Java / JSON / REST API 天然兼容
- 日志与调试友好
- 避免 BINARY(16) 带来的类型转换成本
- 当前业务规模下性能可接受

> UUID **仅由 Java 层生成**，数据库不负责生成。

------

### 2.2 Soft Delete First

- 所有业务数据默认 **软删除**
- 永不直接 `DELETE`，除非离线清理任务
- 查询必须显式加：

```
WHERE is_deleted = 0
```

------

### 2.3 Read-Optimized Feed

- 不做 Feed 写扩散（Inbox）
- 使用 **拉模式 + 索引 + 条件过滤**
- 以可维护性和一致性优先

------

## 3. Schema Overview

```
database/
├── auth
│   ├── user
│   ├── email_otp
│   ├── auth_session
│   └── auth_login_log
│
├── relation
│   ├── user_follow
│   └── user_block
│
├── recommend
│   ├── recommend_content
│   ├── recommend_quote
│   ├── recommend_article
│   ├── recommend_book
│   ├── recommend_movie
│   ├── recommend_painting
│   ├── recommend_music
│   ├── recommend_music_lyric
│   ├── daily_recommendation
│   └── daily_recommendation_item
│
├── community
│   ├── post
│   ├── post_image
│   ├── post_audio
│   ├── comment
│   ├── like_action
│   └── post_favorite
│
├── question
│   ├── daily_question
│   ├── daily_question_pick
│   └── daily_question_answer
│
├── common
│   ├── tag
│   ├── tag_map
│   ├── search_document
│   └── counter_event
│
└── admin
    ├── admin_user
    ├── admin_role
    ├── admin_permission
    ├── admin_user_role
    ├── admin_role_permission
    └── admin_audit_log
```

------

## 4. Core Tables Explained

### 4.1 `user`

用户基础信息表。

关键点：

- `email` 唯一
- `nickname` 由 Java 随机生成 + 数据库唯一索引兜底
- 支持注销 → 匿名化 → 冷静期 → 删除

```
user
├── id (UUID)
├── email
├── password_hash
├── email_verified
├── nickname
├── avatar_url
├── status
├── anonymized_at
├── cooldown_until
└── is_deleted
```

------

### 4.2 `post`（声音社区核心）

支持 **文字 / 多图 / 音频** 的统一内容模型。

```
post
├── id
├── user_id
├── text
├── visibility (1公开 / 2仅粉丝 / 3仅自己)
├── like_count
├── comment_count
├── favorite_count
├── pv / uv
├── status
└── created_at
```

一对多拆表：

- `post_image`
- `post_audio`

------

### 4.3 `comment`（两层楼中楼）

- **严格限制两层**
- `depth = 0 | 1`
- `root_id` 指向一级评论

```
comment
├── id
├── post_id
├── user_id
├── parent_id
├── root_id
├── depth
└── content
```

------

### 4.4 `like_action`（统一点赞表）

支持点赞对象：

- 帖子
- 评论
- 推荐内容
- 每日一问回答

```
like_action
├── user_id
├── target_type
├── target_id
└── created_at
```

唯一约束：

```
UNIQUE(user_id, target_type, target_id)
```

------

### 4.5 推荐系统（混合模型）

- **`recommend_content`**：公共元数据
- **`recommend_xxx`**：按类型拆表
- **`daily_recommendation`**：用户 × 日期
- **`daily_recommendation_item`**：每天每类 1 条

优势：

- 扩展新内容类型成本低
- 推荐逻辑清晰
- 查询结构稳定

------

## 5. Feed Design (Pull Model)

### 5.1 可见性规则

| visibility | 说明       |
| ---------- | ---------- |
| 1          | 所有人可见 |
| 2          | 仅粉丝     |
| 3          | 仅自己     |

------

### 5.2 黑名单规则（关键）

Feed 查询时 **双向屏蔽**：

- Viewer 屏蔽 Author → 不可见
- Author 屏蔽 Viewer → 不可见

即：

```
A 看不到 B  <=>  A block B OR B block A
```

------

### 5.3 Feed 查询（Keyset 分页）

```
ORDER BY p.created_at DESC, p.id DESC
AND (
  p.created_at < :cursorCreatedAt
  OR (p.created_at = :cursorCreatedAt AND p.id < :cursorId)
)
LIMIT :limit
```

------

## 6. Pagination Strategy

| 场景            | 方案               |
| --------------- | ------------------ |
| Feed / Timeline | Keyset 分页        |
| 管理后台        | Offset 分页        |
| 搜索结果        | Offset（可控页数） |

------

## 7. Index Strategy

### 7.1 Feed 必备索引

```
post(created_at, id)
user_follow(follower_id, followee_id, status)
user_block(blocker_id, blocked_id, status)
like_action(user_id, target_type, target_id)
post_favorite(user_id, post_id)
```

### 7.2 原则

- 索引服务于 **查询路径**
- 避免“为了索引而索引”
- 联合索引字段顺序 = 查询条件顺序

------

## 8. Counter & Async Update

### 8.1 冗余计数

- `like_count`
- `comment_count`
- `favorite_count`
- `pv / uv`

### 8.2 更新策略

- 行为发生 → 写入 `counter_event`
- 异步任务聚合更新主表
- 避免热点行竞争

------

## 9. Search Design

### Current

- MySQL `FULLTEXT`
- 表：`search_document`

### Future

- Elasticsearch / OpenSearch
- 结构保持一致
- 无需改业务代码

------

## 10. MyBatis Usage Guide

### 10.1 Parameter Binding

✅ 使用：

```
#{param}
```

❌ 禁止：

```
${param}
```

------

### 10.2 One-to-Many Query

❌ 不推荐：

```
post JOIN post_image
```

✅ 推荐：

1. 主查询分页
2. IN 查询批量拉子表
3. Java 层组装

------

## 11. Data Lifecycle & Compliance

### 11.1 User Deletion

1. 立即匿名化
2. 冷静期 30 天
3. 过期后物理删除 / 彻底软删

### 11.2 Snapshot

- 使用 `user_deletion_snapshot`
- 冷静期内可恢复
- 到期必须清理

------

## 12. Common Pitfalls

- ❌ 在数据库生成 UUID
- ❌ Feed 深分页 OFFSET
- ❌ 忽略黑名单双向规则
- ❌ 计数实时更新
- ❌ 一个 SQL 拉全量一对多
- ❌ 直接 DELETE 业务数据

------

## 13. Future Extensions

- 推荐算法升级（Embedding / CF）
- Feed 热度排序
- 内容审核系统
- ES 搜索替换 FULLTEXT
- 冷数据归档

------

## 14. How to Use

```
# 初始化数据库
mysql -u root -p < schema.sql
schema.sql
└── 完整建表脚本（见 database/schema.sql）
```

------

## 15. License

Internal project use only.