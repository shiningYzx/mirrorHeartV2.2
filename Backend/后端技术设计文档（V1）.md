# 后端技术设计文档

## 1. 项目概述

### 1.1 项目目标

本项目为**内容 + 社区 + 推荐 + 每日问答**类应用的后端系统，提供：

- 普通用户端 API（发帖、评论、点赞、推荐、每日一问等）
- 管理端 API（内容管理、权限管理、审计日志）
- 基于 JWT 的无状态认证
- 基于 RBAC 的管理端权限控制
- 可扩展的 AI 能力接入

### 1.2 技术选型

| 层级     | 技术                             |
| -------- | -------------------------------- |
| Web 框架 | Spring Boot                      |
| ORM      | MyBatis-Plus + MyBatis XML       |
| 数据库   | MySQL                            |
| 安全     | Spring Security + JWT（双token） |
| 权限模型 | RBAC（管理端）                   |
| 构建     | Maven                            |
| JSON     | Jackson                          |
| AI 集成  | 外部 API（OpenAI 等，可替换）    |

------

## 2. 整体架构设计

### 2.1 分层架构

```
Controller  →  Service  →  Repository  →  Dao (MyBatis-Plus)  →  DB
                                 ↘  XML Mapper（复杂 SQL）
```

**设计原则：**

- Controller：只做参数校验与响应封装
- Service：业务编排、事务边界
- Repository：领域级数据访问抽象（避免 Service 直接散落 Mapper 调用）
- Dao：纯数据库 CRUD（BaseMapper + XML）
- XML：复杂查询 / 多表 JOIN / 性能敏感 SQL

------

## 3. 模块与目录结构

### 3.1 resources 目录

```
src/main/resources
├── application.yml
├── mapper/                     # MyBatis XML（按业务域）
│   ├── auth/
│   ├── relation/
│   ├── recommend/
│   ├── community/
│   ├── question/
│   ├── common/
│   └── admin/
└── db/
    ├── schema.sql               # 初始化表（可选）
    └── data.sql                 # 初始化数据（可选）
```

### 3.2 Java 目录（核心）

```
com.example.demo
├── config/                      # Security / MyBatis / Web 配置
├── common/                      # 通用能力（返回、异常、安全、工具）
├── integration/                 # 外部系统集成（AI、存储等）
├── module/                      # 按业务域拆分
│   ├── auth/
│   ├── relation/
│   ├── recommend/
│   ├── community/
│   ├── question/
│   ├── commondata/
│   └── admin/
└── DemoApplication.java
```

------

## 4. 数据库设计概览

### 4.1 业务分域

```
database/
├── auth        # 用户、登录、会话
├── relation    # 关注 / 拉黑
├── recommend   # 推荐内容、每日推荐
├── community   # 帖子、评论、点赞、收藏
├── question    # 每日一问
├── common      # 标签、搜索、计数
└── admin       # 管理员、角色、权限、审计
```

### 4.2 管理端 RBAC 模型

```
admin_user
  ↓
admin_user_role
  ↓
admin_role
  ↓
admin_role_permission
  ↓
admin_permission
```

- **角色（Role）**：权限集合
- **权限（Permission）**：最小操作粒度（如 `post:delete`）

------

## 5. 安全设计（Spring Security + JWT）

### 5.1 双入口安全策略

| 入口        | 说明                |
| ----------- | ------------------- |
| `/api/**`   | 用户端，仅 JWT 鉴权 |
| `/admin/**` | 管理端，JWT + RBAC  |

### 5.2 JWT 设计

- Header：`Authorization: Bearer <token>`
- Token 内容：
  - subject：userId / adminId
  - roles / permissions
  - issuedAt / expiration
- 无 Session（`STATELESS`）

### 5.3 白名单策略

用户端白名单示例：

- `/api/auth/**`
- `/api/recommend/today`
- `GET /api/posts/**`

------

## 6. 统一返回与异常设计

### 6.1 统一返回体

```
{
  "code": 0,
  "message": "success",
  "data": {}
}
```

- 所有业务接口默认统一包装
- 可通过注解（如 `@NoWrap`）跳过

### 6.2 错误码设计

```
public enum ErrorCode {
    SUCCESS(0, "success"),
    PARAM_ERROR(40001, "参数错误"),
    UNAUTHORIZED(40100, "未登录"),
    FORBIDDEN(40300, "无权限"),
    NOT_FOUND(40400, "资源不存在"),
    BIZ_ERROR(50001, "业务异常");
}
```

### 6.3 业务异常

- 使用 `BizException(ErrorCode)`
- `GlobalExceptionHandler` 统一转换为 JSON 响应

------

## 7. 分页设计（简单可控）

### 7.1 MyBatis-Plus 分页

```
Page<PostEntity> page = new Page<>(pageNo, pageSize);
IPage<PostEntity> result = postDao.selectPage(page, wrapper);
```

### 7.2 统一分页响应

```
{
  "list": [],
  "page": 1,
  "size": 20,
  "total": 123
}
```

------

## 8. Repository 抽象设计

### 8.1 设计动机

避免：

- Service 直接操作多个 Mapper
- SQL 语义散落在业务层

### 8.2 示例

```
public interface PostRepository {
    PostEntity getById(Long id);
    IPage<PostEntity> pageVisiblePosts(Page<?> page);
    void savePostWithMedia(PostEntity post);
}
```

Repository 内部：

- 调用 Dao（BaseMapper）
- 调用 XML Mapper
- 封装 JOIN / 组合查询

------

## 9. REST 接口风格约定

### 9.1 用户端示例

| 方法 | 路径                       | 说明     |
| ---- | -------------------------- | -------- |
| GET  | `/api/posts`               | 帖子列表 |
| GET  | `/api/posts/{id}`          | 帖子详情 |
| POST | `/api/posts`               | 发帖     |
| POST | `/api/posts/{id}/like`     | 点赞     |
| POST | `/api/posts/{id}/comments` | 评论     |

### 9.2 管理端示例

| 方法   | 路径                | 权限          |
| ------ | ------------------- | ------------- |
| GET    | `/admin/posts`      | `post:view`   |
| DELETE | `/admin/posts/{id}` | `post:delete` |
| POST   | `/admin/roles`      | `role:create` |

------

## 10. AI 能力接入设计

### 10.1 集成方式

```
Controller → Service → integration/ai/AiClient
```

### 10.2 可扩展点

- 支持多模型实现（OpenAI / 本地模型）
- AI 能力与业务模块解耦
- 可用于：
  - 推荐文案生成
  - 内容摘要
  - 问答辅助

------

## 11. 事务与一致性

- Service 层定义事务边界
- 读写分离前预留 Repository 抽象
- 计数类操作（点赞数、PV/UV）使用事件/异步更新（`counter_event`）

------

## 12. 常见风险与约定

| 风险          | 约定                  |
| ------------- | --------------------- |
| N+1 查询      | Repository + XML JOIN |
| 权限膨胀      | 仅管理端使用 RBAC     |
| 返回格式混乱  | 强制 ApiResponse      |
| 安全误放行    | 双 FilterChain        |
| AI 依赖不稳定 | integration 层隔离    |

------

## 13. 总结

该后端架构具备：

- 清晰的分域与分层
- 工程级可维护性
- 可扩展的安全与权限体系
- 对 AI 能力友好的集成方式
- 适合中大型项目长期演进